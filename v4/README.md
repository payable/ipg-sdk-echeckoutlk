### eCheckoutLK IPG SDK

eCheckoutLK IPG SDK helps to integrate the eCheckoutLK Payment Gateway to your website.

<hr>

#### The eCheckoutLK Payment Gateway Integration

First, You need to get the Merchant Key and Merchant Token to integrate with the IPG SDK from eCheckoutLK Merchant Portal

- Merchant Key:
- Merchant Token:

You can simply use an HTML Form to submit the below params to eCheckoutLK Payment Gateway.When your customer clicks on the payment/checkout button, It will be redirected to the eCheckoutLK Payment Gateway. The Customer can confirm the payment by clicking on the 'continue' button. Then your customer will be securely redirected to the Payment Gateway and the customer can then enter the credentials (Card No / Cardholder name / CVV ) and process the payment there. Once the payment is made, The eCheckoutLK payment gateway will show the payment status to your customer and send the receipt to your customer's email.

<hr>

### Version V4

<hr>

### Implementation

<b>1.</b> Add Checkout URL into your checkout page.

eCheckoutLK Checkout URL:

```html
Sandbox: https://sandboxipgsdk.echeckout.lk/sdk/v4/echeckout-checkout.js
```

```html
Live: https://ipgsdk.echeckout.lk/sdk/v4/echeckout-checkout.js
```

<b>2.</b> Create your checkout form with basic required fields.

<b>2.1.</b> Required Form Parameters:

- `notifyUrl` - URL to callback the status of the payment (Needs to be a URL accessible on a public IP/domain)
- `returnUrl` - URL to redirect users when success
- `logoUrl` - Logo url to show the logo in SDK
- `merchantKey` - eCheckoutLK Merchant ID [Given by eCheckoutLK]
- `currencyCode` - Currency Code (LKR/EUR/GBP/USD)
- `checkValue` - Generated hash value to ensure extra security
- `orderDescription` - Small Description for the Order
- `amount` - Total Payment Amount
- `invoiceId` - Invoice ID generated by the merchant
- `paymentType` - Payment Type (1 means ONE_TIME_PAYMENT, 2 means RECURRING_PAYMENT)
- `customerFirstName`- Customer’s First Name
- `customerLastName` - Customer’s Last Name
- `customerMobilePhone`- Customer’s Mobile No
- `customerEmail` - Customer’s Email
- `billingAddressStreet` - Billing Address Line1
- `billingAddressCity`- Billing City
- `billingAddressCountry` - Billing Country

<b>2.2.</b> Payment type Parameters: Following parameters are required if the payment type is 2

- `startDate` - Payment Start Date
- `endDate` - Payment End Date (It can be any date or FOREVER)
- `recurringAmount` - Recurring payment Amount
- `interval` - Payment Interval (It can be MONTHLY,ANNUALLY)
- `isRetry` - Is Retry
- `retryAttempts` - Retry Attempts
- `doFirstPayment` - Do First Payment

<b>2.3.</b> Optional Form Parameters:

- `custom1` - Merchant specific data, a Custom 1
- `custom2` - Merchant specific data, a Custom 2
- `customerPhone` - Customer’s Phone No
- `billingAddressStreet2` - Billing Address Line2
- `billingCompanyName` - Billing Company
- `billingAddressPostcodeZip` - Billing Postal Code
- `billingAddressStateProvince` - Billing Province
- `shippingContactFirstName` - Shipping Contact First Name
- `shippingContactLastName` - Shipping Contact Last Name
- `shippingContactMobilePhone` - Shipping Contact Mobile No
- `shippingContactPhone` - Shipping Contact Phone No
- `shippingContactEmail` - Shipping Contact Email
- `shippingCompanyName` - Shipping Contact Company
- `shippingAddressStreet` - Shipping Address Line1
- `shippingAddressStreet2` - Shipping Address Line2
- `shippingAddressCity` - Shipping City
- `shippingAddressStateProvince` - Shipping Province
- `shippingAddressCountry` - Shipping Country (LKA)
- `shippingAddressPostcodeZip` - Shipping Postal Code

In Request, `checkValue` is a combination of merchant key, invoice id, amount, currency parameter set in a predefined sequence given by eCheckoutLK which then encrypted with merchant token (a unique Secret value for the Merchant which was shared by eCheckoutLK) using SHA-512.

Format:

`UPPERCASE(SHA512[<merchantKey>|<invoiceId>|<amount>|<currencyCode>|UPPERCASE(SHA512[<merchantToken>])])`

<b>2.3.</b> Sample form :

```html
<form method="post">
  <!-- Replace your merchantKey, notifyUrl, returnUrl, and checkValue -->
  <input
    type="hidden"
    name="notifyUrl"
    id="notifyUrl"
    value="https://yoursite.com/payment/nortify"
  />
  <input
    type="hidden"
    name="returnUrl"
    id="returnUrl"
    value="https://yoursite.com/payment/return"
  />
  <input
    type="hidden"
    name="logoUrl"
    id="logoUrl"
    value="https://yoursite.com/payment/logo.png"
  />
  <input
    type="hidden"
    name="merchantKey"
    id="merchantKey"
    value="D75XXXXXXXXX"
  />
  <input
    type="hidden"
    name="checkValue"
    id="checkValue"
    value="A8907A75XXXXXXXXXXXXXXXXXXX"
  />
  <input type="hidden" name="custom1" id="custom1" value="test value" />
  <input type="hidden" name="custom2" id="custom2" value="test value" />
  <h3>Payment Details</h3>
  <input type="text" name="invoiceId" id="invoiceId" value="INV0002301" />
  <input
    type="text"
    name="orderDescription"
    id="orderDescription"
    value="Payment for abc Fashion"
  />
  <input type="text" name="amount" id="amount" value="999.12" />
  <input type="hidden" name="currencyCode" id="currencyCode" value="LKR" />
  <input type="hidden" name="paymentType" id="paymentType" value="2" />
  <input type="hidden" name="startDate" id="startDate" value="2023-11-18" />
  <input type="hidden" name="endDate" id="endDate" value="FOREVER" />
  <input
    type="hidden"
    name="recurringAmount"
    id="recurringAmount"
    value="2.00"
  />
  <input type="hidden" name="interval" id="interval" value="MONTHLY" />
  <input type="hidden" name="isRetry" id="isRetry" value="1" />
  <input type="hidden" name="retryAttempts" id="retryAttempts" value="1" />
  <input type="hidden" name="doFirstPayment" id="doFirstPayment" value="1" />
  <h3>Customer Details</h3>
  <input
    type="text"
    name="customerFirstName"
    id="customerFirstName"
    value="Shakthi"
  />
  <input
    type="text"
    name="customerLastName"
    id="customerLastName"
    value="Elon"
  />
  <input
    type="text"
    name="customerMobilePhone"
    id="customerMobilePhone"
    value="94XXXXXXXXX"
  />
  <input
    type="text"
    name="customerPhone"
    id="customerPhone"
    value="94XXXXXXXXX"
  />
  <input
    type="email"
    name="customerEmail"
    id="customerEmail"
    value="testbillmail@gmail.com"
  />
  <h3>Billing Details</h3>
  <input
    type="text"
    name="billingAddressStreet"
    id="billingAddressStreet"
    value="154"
  />
  <input
    type="text"
    name="billingAddressStreet2"
    id="billingAddressStreet2"
    value="Main Road"
  />
  <input
    type="text"
    name="billingCompanyName"
    id="billingCompanyName"
    value="Test"
  />
  <input
    type="text"
    name="billingAddressCity"
    id="billingAddressCity"
    value="Vavuniya"
  />
  <input
    type="text"
    name="billingAddressStateProvince"
    id="billingAddressStateProvince"
    value="North Province"
  />
  <input
    type="hidden"
    name="billingAddressCountry"
    id="billingAddressCountry"
    value="LKA"
  />
  <input
    type="text"
    name="billingAddressPostcodeZip"
    id="billingAddressPostcodeZip"
    value="43000"
  />
  <h3>Shipping Details</h3>
  <input
    type="text"
    name="shippingContactFirstName"
    id="shippingContactFirstName"
    value="Kumar"
  />
  <input
    type="text"
    name="shippingContactLastName"
    id="shippingContactLastName"
    value="Shiva"
  />
  <input
    type="text"
    name="shippingContactPhone"
    id="shippingContactPhone"
    value="94XXXXXXXXX"
  />
  <input
    type="text"
    name="shippingContactMobilePhone"
    id="shippingContactMobilePhone"
    value="94XXXXXXXXX"
  />
  <input
    type="email"
    name="shippingContactEmail"
    id="shippingContactEmail"
    value="testshipmail@gmail.com"
  />
  <input
    type="text"
    name="shippingCompanyName"
    id="shippingCompanyName"
    value="eCheckoutLK"
  />
  <input
    type="text"
    name="shippingAddressStreet"
    id="shippingAddressStreet"
    value="Main Street"
  />
  <input
    type="text"
    name="shippingAddressStreet2"
    id="shippingAddressStreet2"
    value="Temple Road"
  />
  <input
    type="text"
    name="shippingAddressCity"
    id="shippingAddressCity"
    value="Colombo"
  />
  <input
    type="text"
    name="shippingAddressStateProvince"
    id="shippingAddressStateProvince"
    value="western province"
  />
  <input
    type="hidden"
    name="shippingAddressCountry"
    id="shippingAddressCountry"
    value="LKA"
  />
  <input
    type="text"
    name="shippingAddressPostcodeZip"
    id="shippingAddressPostcodeZip"
    value="40000"
  />
  <input type="submit" value="PAY Now" />
</form>
```

<b>3.</b> Communicate with eCheckoutLK SDK.

<b>3.1.</b> Submit your form json data into `echeckoutPayment()`.

```javascript
echeckoutPayment(form_jsondata);
```

<b>3.2.</b> Payment related Error details.

Error will be field validation (code : 3009) and other common errors.

This is the sample validation error json

```json
{
  "status": 3009,
  "success": false,
  "error": {
    "startDate": ["Start date should be today date."]
  }
}
```

Other common error(status can be 400/500/any other)

```json
{
  "status": 400,
  "success": false,
  "error": "Something went wrong. Please contact your merchant."
}
```

<hr>

#### Listening to Payment Notification Data

eCheckoutLK Payment Gateway will send back to your website notifies the payment status to the `notifyUrl`. You need to get the request and send the response.

- It cannot test the payment notification by print/echo methods since `notifyUrl` never
  loads to the browser as it's a server callback. You can only test it by updating your database upon
  fetching the notification.
- It cannot test the payment notification on localhost. You need to submit a publicly accessible IP or
  domain based URL as your `notifyUrl` is to directly notify your server.

##### Server callback Json (One-time Payment)

```json
{
  "merchantKey": "SXXXXXXXX",
  "echeckoutOrderId": "oid-XXXXXXXX-XXX-XXXX-XXXX-XXXX",
  "echeckoutTransactionId": "XXXXXXXX-XXX-XXXX-XXXX-XXXXXXXXX",
  "echeckoutAmount": "1000.60",
  "echeckoutCurrency": "LKR",
  "invoiceNo": "INVvw5EA0d1pH",
  "statusCode": 1,
  "statusMessage": "SUCCESS",
  "paymentType": 1,
  "paymentMethod": 1,
  "paymentScheme": "MASTERCARD",
  "custom1": "test 1",
  "custom2": "test 2",
  "cardHolderName": "Shakthi",
  "cardNumber": "512345xxxxxx0008",
  "checkValue": "256XXXXXXXXXXXXXX"
}
```

##### Description

- `echeckoutOrderId` - Unique Order Id generated by eCheckoutLK
- `echeckoutTransactionId` - Unique Transaction Reference Id generated by eCheckoutLK for the processed payment
- `echeckoutAmount`- Total amount of the Payment
- `echeckoutCurrency` - Currency Code of the Payment (LKR Only)
- `invoiceNo` - Unique Id sent by Merchant to the Checkout page
- `statusMessage` - Message received from payment gateway which the customer tried to pay(SUCCESS/FAILURE)
- `paymentType` - Payment type selected during the Checkout
  1. CARD (SUPPORTED)
  2. BANKING (Not implemented yet)
  3. WALLET (Not implemented yet)
- `paymentMethod` - Payment method selected during the Checkout
  1. VISA / MASTERCARD / CUP(Visa and Mastercard are SUPPORTED / CUP Not implemented Yet)
  2. AMEX / DINERS CLUB / DISCOVER
  3. SAMPATH VISHWA (Not implemented yet)
- `paymentScheme` - Payment scheme selected by the customer (VISA / MASTERCARD)

If the customer made the payment by VISA or MASTER credit/debit card, following cardHolderName and cardNumber parameters will also be available.

- `cardHolderName` -Name on the Card
- `cardNumber` - Masked card number (Ex: \***\*\*\*\*\*\*\***0008)
- `checkValue` - combination of merchantKey, echeckoutOrderId, echeckoutTransactionId, echeckoutAmount, echeckoutCurrency, invoiceId, statusCode parameter set in a predefined sequence given by eCheckoutLK which then encrypted with merchantToken (a unique Secret value for the Merchant which was shared by eCheckoutLK) using SHA-512.

Format:

```
UPPERCASE(SHA512[<merchantKey>|<echeckoutOrderId>|<echeckoutTransactionId>|<echeckoutAmount>|<echeckoutCurrency>|<invoiceId>|<statusCode>|UPPERCASE(SHA512[<MerchantToken>])])
```

**Important Notes:**

- `merchantToken` is a secret shared by eCheckoutLK for your merchant
- Use exact field order and string concatenation with `|` as delimiter
- Compare your locally computed checkValue with the webhook's value (case-sensitive match)

##### Send response to callback

```json
{
  "Status": 200
}
```

#### Server Callbacks (Webhooks) for Recurring Payments

For recurring payments (`paymentType=2`), callbacks are sent to your `notifyUrl` for:

- Initial payment attempt
- Every recurring cycle
- Retry attempts (if enabled)

##### Recurring Payment Callback - Initial Attempt

```json
{
  "merchantKey": "SXXXXXXXX",
  "echeckoutOrderId": "oid-XXXXXXXX-XXX-XXXX-XXXX-XXXX",
  "echeckoutTransactionId": "XXXXXXXX-XXX-XXXX-XXXX-XXXXXXXXX",
  "echeckoutAmount": "1000.60",
  "echeckoutCurrency": "LKR",
  "invoiceNo": "INVvw5EA0d1pH",
  "statusCode": 1,
  "statusMessage": "SUCCESS",
  "paymentType": 2,
  "paymentMethod": 1,
  "paymentScheme": "MASTERCARD",
  "custom1": "test 1",
  "custom2": "test 2",
  "cardHolderName": "Shakthi",
  "cardNumber": "512345xxxxxx0008",
  "recurring": {
    "subscriptionId": "XXXXXXXX-XXX-XXXX-XXXX-XXXXXXXXX",
    "recurringAmount": "1000.60",
    "startDate": "2025-09-03",
    "endDate": "FOREVER",
    "interval": "MONTHLY",
    "isRetry": 1,
    "retryAttempts": 3,
    "doFirstPayment": 1,
    "nextPaymentDate": "2025-10-03",
    "noOfSuccessPayments": 1,
    "subscriptionStatusCode": 1
  },
  "checkValue": "256XXXXXXXXXXXXXX"
}
```

##### Recurring Payment Callback - Recurring/Retry Attempt

```json
{
  "merchantKey": "SXXXXXXXX",
  "echeckoutOrderId": "oid-XXXXXXXX-XXX-XXXX-XXXX-XXXX",
  "echeckoutTransactionId": "XXXXXXXX-XXX-XXXX-XXXX-XXXXXXXXX",
  "echeckoutAmount": "1000.60",
  "echeckoutCurrency": "LKR",
  "invoiceNo": "INVvw5EA0d1pH",
  "statusCode": 1,
  "statusMessage": "SUCCESS",
  "paymentType": 2,
  "paymentMethod": 1,
  "paymentScheme": "MASTERCARD",
  "custom1": "test 1",
  "custom2": "test 2",
  "cardHolderName": "Shakthi",
  "cardNumber": "512345xxxxxx0008",
  "recurring": {
    "subscriptionId": "XXXXXXXX-XXX-XXXX-XXXX-XXXXXXXXX",
    "recurringAmount": "1000.60",
    "startDate": "2025-09-03",
    "endDate": "FOREVER",
    "interval": "MONTHLY",
    "isRetry": 1,
    "retryAttempts": 3,
    "doFirstPayment": 1,
    "nextPaymentDate": "2025-11-03",
    "noOfSuccessPayments": 2,
    "subscriptionStatusCode": 1,
    "lastPaymentAttempt": {
      "isRetried": 1,
      "attemptCount": 2,
      "txDateTime": "2025-10-05T10:22:31+05:30",
      "attemptStatus": "SUCCESS",
      "transactionId": "XXXXXXXX-XXX-XXXX-XXXX-XXXXXXXXX"
    }
  },
  "checkValue": "256XXXXXXXXXXXXXX"
}
```

##### Recurring Callback Fields

**Core Fields:**

- `subscriptionId` - Unique subscription identifier
- `recurringAmount` - Amount charged per cycle
- `startDate` - Subscription start date
- `endDate` - Subscription end date (or "FOREVER")
- `interval` - Billing interval (MONTHLY/ANNUALLY)
- `nextPaymentDate` - Next scheduled payment date
- `noOfSuccessPayments` - Count of successful payments
- `subscriptionStatusCode` - 1=Active, 2=Completed, 3=Cancelled

**Retry Information (if applicable):**

- `lastPaymentAttempt.isRetried` - Whether this was a retry attempt
- `lastPaymentAttempt.attemptCount` - Retry attempt number
- `lastPaymentAttempt.txDateTime` - Transaction timestamp
- `lastPaymentAttempt.attemptStatus` - Status of this attempt

<hr>

##### Sample Code

```html
<html>
  <head>
    <title>ABC Fashion Shop</title>
    <script src="https://sandboxipgsdk.echeckout.lk/sdk/v4/echeckout-checkout.js"></script>
    <script>
      function returnForm() {
        const payment = {
          logoUrl: "https://your_domain/logo.png",
          returnUrl: "https://your_domain/returnpage",
          checkValue: "ZXYXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",
          orderDescription: "Payment for furni",
          invoiceId: "lwchlqlz",
          merchantKey: "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",
          customerFirstName: "customer first name",
          customerLastName: "customer last name",
          customerMobilePhone: "0XXXXXXXXX",
          customerEmail: "testmail@gmail.com",
          billingAddressStreet: "Main street",
          billingAddressCity: "Vavuniya",
          billingAddressCountry: "LKA",
          amount: "100.00",
          currencyCode: "LKR",
          paymentType: "2",
          startDate: "2024-01-25",
          endDate: "2024-12-20",
          recurringAmount: "2.00",
          interval: "MONTHLY",
          isRetry: "1",
          retryAttempts: "1",
          doFirstPayment: "1",
          notifyUrl: "https://your_domain/your_notify_path",
        };
        echeckoutPayment(payment);
      }
    </script>
  </head>
  <body>
    <button onclick="returnForm()" name="btnpay">PAY Now</button>
  </body>
</html>
```

##### Sample code for checkValue generation (PHP):

```php
<?php
function generateCheckValue($merchantKey, $invoiceId, $amount, $currencyCode, $merchantToken) {
    // Step 1: Create SHA512 hash of merchantToken and convert to uppercase
    $tokenHash = strtoupper(hash('sha512', $merchantToken));

    // Step 2: Create the base string with pipe delimiters
    $baseString = $merchantKey . "|" . $invoiceId . "|" . $amount . "|" . $currencyCode . "|" . $tokenHash;

    // Step 3: Create final SHA512 hash and convert to uppercase
    $finalHash = strtoupper(hash('sha512', $baseString));

    return $finalHash;
}

// Example usage
$checkValue = generateCheckValue("D75XXXXXXXXX", "INV0002301", "999.12", "LKR", "your_secret_merchant_token");
echo "Generated checkValue: " . $checkValue;
?>
```

eCheckoutLK Payment Gateway Integration
